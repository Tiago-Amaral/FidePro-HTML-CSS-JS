<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro de Clientes</title>
  <link rel="stylesheet" href="../style.css" />
  <script src="./firebase-config.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <div id="mensagemStatus" class="mensagem-status"></div>

  <div class="container">
    <h1>Cadastro de Clientes</h1>

    <form id="formCliente">
      <input type="text" id="nome" placeholder="Nome" required />
      <input type="email" id="email" placeholder="Email" />
      <input type="tel" id="telefone" placeholder="Telefone" required />
      <input type="text" id="cidade" placeholder="Cidade" />
      <input type="date" id="nascimento" placeholder="Nascimento" />

      <h3>Última Compra</h3>
      <input type="text" id="produto" placeholder="Produto" />
      <input type="text" id="categoria" placeholder="Categoria" />
      <input type="number" id="quantidade" placeholder="Quantidade" />
      <input type="number" id="preco" placeholder="Preço" step="0.01" />
      <input type="date" id="dataCompra" placeholder="Data da compra" />
      <input type="number" id="duracao" placeholder="Duração (dias)" />

      <button type="submit">Cadastrar Cliente</button>
    </form>

    <hr />
    
    <!-- Menu inferior -->
    <div class="mobile-menu">
      <a href="home.html" class="menu-item"><i class="fas fa-home"></i></a>
      <a href="form.html" class="menu-item"><i class="fas fa-user-plus"></i></a>
      <a href="clientes.html" class="menu-item"><i class="fas fa-users"></i></a>
      <a href="graficos.html" class="menu-item"><i class="fas fa-chart-bar"></i></a>
    </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    // Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Mostrar mensagem igual ao login/cadastro
    function mostrarMensagem(texto, tipo) {
      const div = document.getElementById("mensagemStatus");
      div.textContent = texto;
      div.className = "mensagem-status " + (tipo === "sucesso" ? "sucesso" : "erro");
      div.style.display = "block";

      setTimeout(() => {
        div.style.display = "none";
      }, 4000);
    }

    const form = document.getElementById("formCliente");
    const lista = document.getElementById("listaClientes");
    const alertaNotificacao = document.getElementById("alertaNotificacao");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const cliente = {
        nome: document.getElementById("nome").value,
        email: document.getElementById("email").value,
        telefone: document.getElementById("telefone").value,
        cidade: document.getElementById("cidade").value,
        nascimento: document.getElementById("nascimento").value,
        compras: [{
          produto: document.getElementById("produto").value,
          categoria: document.getElementById("categoria").value,
          quantidade: parseInt(document.getElementById("quantidade").value || 0),
          preco: parseFloat(document.getElementById("preco").value || 0),
          data: document.getElementById("dataCompra").value,
          duracao: parseInt(document.getElementById("duracao").value || 0)
        }]
      };

      try {
        await addDoc(collection(db, "clientes"), cliente);
        mostrarMensagem("Cliente cadastrado com sucesso!", "sucesso");
        form.reset();
        carregarClientes();
      } catch (error) {
        console.error("Erro ao adicionar cliente: ", error);
        mostrarMensagem("Erro ao cadastrar cliente.", "erro");
      }
    });

    async function carregarClientes(filtro = "") {
      lista.innerHTML = "";
      const hoje = new Date();

      const snapshot = await getDocs(collection(db, "clientes"));
      const clientes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      const aniversariantes = clientes.filter(cliente => {
        if (!cliente.nascimento) return false;
        const [ano, mes, dia] = cliente.nascimento.split("-");
        return parseInt(dia) === hoje.getDate() && parseInt(mes) === hoje.getMonth() + 1;
      });

      const clientesRecompra = clientes.filter(cliente => {
        const ultimaCompra = cliente.compras?.at(-1);
        if (!ultimaCompra) return false;
        const dataRecompraStr = adicionarDias(ultimaCompra.data, ultimaCompra.duracao);
        const dataRecompra = new Date(dataRecompraStr);
        const diff = calcularDiferencaDias(dataRecompra, hoje);
        return diff >= 0 && diff <= 3;
      });

      if (aniversariantes.length > 0 || clientesRecompra.length > 0) {
        alertaNotificacao.style.display = "block";
        alertaNotificacao.classList.add("notificacao-ativa");
      }

      clientes.forEach((cliente) => {
        if (cliente.nome.toLowerCase().includes(filtro.toLowerCase())) {
          const ultimaCompra = cliente.compras?.at(-1);
          const proximoContato = ultimaCompra ? adicionarDias(ultimaCompra.data, ultimaCompra.duracao) : "—";

          const li = document.createElement("li");
          li.innerHTML = `
            <strong>${cliente.nome}</strong><br>
            Email: ${cliente.email || "—"}<br>
            WhatsApp: ${cliente.telefone}<br>
            Cidade: ${cliente.cidade || "—"}<br>
            Nasc: ${formatarData(cliente.nascimento) || "—"}<br><br>

            <strong>Última compra:</strong><br>
            Produto: ${ultimaCompra?.produto || "—"}<br>
            Categoria: ${ultimaCompra?.categoria || "—"}<br>
            Quantidade: ${ultimaCompra?.quantidade || 0}<br>
            Valor total: R$ ${(ultimaCompra?.quantidade * ultimaCompra?.preco).toFixed(2)}<br>
            Data da compra: ${formatarData(ultimaCompra?.data)}<br>
            Duração estimada: ${ultimaCompra?.duracao || "—"} dias<br>
            <strong>Próximo contato sugerido:</strong> ${formatarData(proximoContato)}<br><br>

            <button onclick="editarCliente('${cliente.id}')">Editar</button>
            <button onclick="removerCliente('${cliente.id}')">Remover</button>
          `;
          lista.appendChild(li);
        }
      });
    }

    function filtrarClientes() {
      const termo = document.getElementById("pesquisaCliente").value;
      carregarClientes(termo);
    }

    function editarCliente(id) {
      localStorage.setItem("clienteEditando", id);
      window.location.href = "index.html";
    }

    async function removerCliente(id) {
      await deleteDoc(doc(db, "clientes", id));
      carregarClientes();
    }

    function adicionarDias(data, dias) {
      const dt = new Date(data);
      dt.setDate(dt.getDate() + parseInt(dias));
      return dt.toISOString().split("T")[0];
    }

    function calcularDiferencaDias(data1, data2) {
      const d1 = new Date(data1);
      const d2 = new Date(data2);
      const diffTime = d1 - d2;
      return Math.ceil(diffTime / (1000 * 3600 * 24));
    }

    function formatarData(dataISO) {
      if (!dataISO) return null;
      const [ano, mes, dia] = dataISO.split("-");
      return `${dia}/${mes}/${ano}`;
    }

    window.onload = () => {
      carregarClientes();
    };
  </script>
</body>
</html>
